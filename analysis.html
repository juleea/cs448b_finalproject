<!DOCTYPE html>
<meta charset="utf-8">
<title>Kijani Grows</title>
<style>

@import url(style.css);

</style>
<script language="javascript" type="text/javascript" src="datetimepicker.js"></script>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
<body>
<input type="Text" id="start" maxlength="25" size="25"><a href="javascript:NewCal('start','ddmmmyyyy',true,24)"><img src="images/cal.gif" width="16" height="16" border="0" alt="Pick a date"></a>
<span class="descriptions">Start!</span>

<input type="Text" id="end" maxlength="25" size="25"><a href="javascript:NewCal('end','ddmmmyyyy',true,24)"><img src="images/cal.gif" width="16" height="16" border="0" alt="Pick a date"></a>
<span class="descriptions">End!</span>

<script src="d3.v2.js"></script>
<script src="cubism.v1.js"></script>
<script>
var context = cubism.context();
var analysis = false;
var startTimeInput, endTimeInput;

var axis = d3.select("body").selectAll(".axis")
    .data(["top", "bottom"])
    .enter().append("div")
    .attr("class", function(d) { return d + " axis"; })
    .each(function(d) { d3.select(this).call(context.axis().ticks(12).orient(d)); });

var rule = d3.select("body").append("div")
    .attr("class", "rule");

function loadData() {
    horizon = d3.select("body").selectAll(".horizon")
    .data(["Photocell (light intensity)", "Flow rate", "Growbed level", "Temperature", "Humidity", "pH", "Conductivity"].map(getData))
    .enter().insert("div", ".bottom")
    .attr("class", "horizon")
    .call(context.horizon().height(50));

horizon2 = d3.select("body").selectAll(".horizon2")
    .data(["Tank full", "Fish feeder", "Fish tank pump", "Flow switch", "Grow lights", "Leak", "Backup reservoir", "Reservoir pump"].map(getData))
    .enter().insert("div", ".bottom")
    .attr("class", "horizon2")
    .call(context.horizon().height(10));

context.on("focus", function(i) {
        //console.log("size " + context.size());
        //console.log(i);
  d3.selectAll(".value").style("right", i == null ? null : context.size() - i + "px");

});
}

loadData();

$('#start').change(function() {
    startTimeInput = $('#start').val();
    endTimeInput = $('#end').val();

    if (startTimeInput != "" && endTimeInput != "") {
        var diff = new Date(endTimeInput) - new Date(startTimeInput);
        var delay = new Date() - new Date(endTimeInput);
        analysis = true;
        //console.log(diff/1e4);
        var curStep = diff/1440;
        console.log("curStep: "+curStep);
        context.serverDelay(delay)
            //.step(1e4)
            .step(curStep)
            .size(1440)
            //.size(diff/1e4)
            .stop();
    } else {
        context.step(1e4)
               .size(1440);
    }
    
    rule.call(context.rule());

    horizon.data(["Photocell (light intensity)", "Flow rate", "Growbed level", "Temperature", "Humidity", "pH", "Conductivity"].map(getData))
    .enter().insert("div", ".bottom")
    .attr("class", "horizon")
    .call(context.horizon().height(50));

    //loadData();
/*d3.select("body").selectAll(".horizon")
    .data(["Photocell (light intensity)", "Flow rate", "Growbed level", "Temperature", "Humidity", "pH", "Conductivity"].map(getData))
    .enter().insert("div", ".bottom")
    .attr("class", "horizon")
    .call(context.horizon().height(50));

d3.select("body").selectAll(".horizon2")
    .data(["Tank full", "Fish feeder", "Fish tank pump", "Flow switch", "Grow lights", "Leak", "Backup reservoir", "Reservoir pump"].map(getData))
    .enter().insert("div", ".bottom")
    .attr("class", "horizon2")
    .call(context.horizon().height(10));

context.on("focus", function(i) {
        //console.log("size " + context.size());
        //console.log(i);
  d3.selectAll(".value").style("right", i == null ? null : context.size() - i + "px");
});
  */

});

function getData(variable) {
    return context.metric(function(start, stop, step, callback) {
        var values = [];
        var numEntries = (stop - start)/1e4;
        var curTime = new Date().toJSON();
        var startTime = new Date(startTimeInput).toJSON(), endTime = new Date(endTimeInput).toJSON();
        var url;
        if (!analysis) {
            url = "http://50.19.108.27/arduino/garden/range/v2?end_time="+curTime+"&num="+numEntries;
        } else {
            url = "http://50.19.108.27/arduino/garden/range/v2?start_time="+startTime+"&end_time="+endTime+"&num="+numEntries;
        }
        console.log(url);
        d3.json(url, function(jsond) {
          start = +start;
          stop = +stop;
          var i= jsond.length-1;
          //var i= Math.max(numEntries,jsond.length) - 1;
          var actual=0, desired=0;
          while (i>0 && start < stop) {
            //console.log(i);
            start += 1e4;
            //start += step
            //desired += step;
            var v;
            if (variable=="Photocell (light intensity)") {
                v = jsond[i].report.photocell_sensor;
                if (v) v = v.lightLevel;
            } else if (variable == "Flow rate") {
                v = jsond[i].report.flow_rate_sensor;
                if (v) v = v.flowRate;
            } else if (variable == "Growbed level") {
                v = jsond[i].report.gb_level_sensor;
                if (v) v = v.gbLevel;
            } else if (variable == "Temperature") {
                v = jsond[i].report.temperature_sensor;
                if (v) v = v.temperature;
            } else if (variable == "Humidity") {
                v = jsond[i].report.humidity_sensor;
                if (v) v = v.humidity;
            } else if (variable == "pH") {
                v = jsond[i].report.ph;
                if (v) v = v.ph;
            } else if (variable == "Conductivity") {
                v = jsond[i].report.conductivity;
                if (v) v = v.ec;
            } else if (variable == "Tank full") {
                v = jsond[i].report.tank_level_sensor;
                if (v) v = v.full;
            } else if (variable == "Fish feeder") {
                v = jsond[i].report.fish_feeder;
                if (v) v = v.on;
            } else if (variable == "Fish tank pump") {
                v = jsond[i].report.fish_tank_pump;
                if (v) v = v.on;
            } else if (variable == "Flow switch") {
                v = jsond[i].report.flow_switch_sensor;
                if (v) v = v.flow;
            } else if (variable == "Grow lights") {
                v = jsond[i].report.grow_lights;
                if (v) v = v.on;
            } else if (variable == "Leak") {
                v = jsond[i].report.leak_detector_sensor;
                if (v) v = v.leak;
            } else if (variable == "Backup reservoir") {
                v = jsond[i].report.reservior_level_sensor;
                if (v) v = v.full;
            } else if (variable == "Reservoir pump") {
                v = jsond[i].report.reservior_pump;
                if (v) v = v.on;
            }
            i--;
            //console.log(1e4/step);
            if (1e4/step > 1) {
                for (var j=0; j<1e4/step; j++) values.push(v);
            } else {
                //console.log("desired: "+desired+" actual: "+actual);
                console.log(desired - actual);
                if (desired - actual < 1e4) {
                    values.push(v);
                    desired += step;
                }
                actual += 1e4;
            }
          }

            //callback(null, values);
            callback(null, values.slice(-context.size()));
        });
    }, variable);
}

</script>



<!DOCTYPE html>
<head>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

	<link type="text/css" rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css">
	<link type="text/css" rel="stylesheet" href="css/graph.css">
	<link type="text/css" rel="stylesheet" href="css/detail.css">
	<link type="text/css" rel="stylesheet" href="css/legend.css">
	<link type="text/css" rel="stylesheet" href="css/lines.css">
    <link type="text/css" rel="stylesheet" href="css/custom.css">
    <link href="http://fonts.googleapis.com/css?family=Calibri" rel="stylesheet" type="text/css">
	
    <script src="../d3.v2.js"></script>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.15/jquery-ui.min.js"></script>
    <script type="text/javascript" src="jquery.jqtransform.js"></script>
    <script type="text/javascript" src="../datagarden.js"></script>
    <link rel="stylesheet" media="all" type="text/css" href="css/jquery-ui-timepicker-addon.css" />
    <script type="text/javascript" src="js/jquery-ui-timepicker-addon.js"></script>

    <!-- // <script src="http://stanford.edu/~jsquared/cgi-bin/clone/datagarden.js"></script> -->

	<script src="rickshaw.js"></script>
	<script src="Rickshaw.Graph.RangeSlider.js"></script>
	
	<!-- FOR ANIMATION -->
	<script type="text/javascript" src="processing.js"></script>
</head>
<body>

<div id="charts">
   
    <div id="preloader"></div>
    <div id="chart_container"></div>

    <div id="legend_container">
        <div id="smoother" title="Smoothing"></div>
        <div id="legend"></div>
    </div>

    <div id="xaxis"></div>

    <div id="slider"></div>
    <div id="inputs">
        <div style="display: none;" id="start_div" align="center" class="float-left"><input type="text" id="start_input"></div>
        <div id="monitor_start_div" align="center" class="float-left"></div>
        <div align="center" class="float-left">

        <input checked id="monitor_input" name="mode" value="monitor" type="radio">Monitor
        <input id="analysis_input" name="mode" value="analysis" type="radio">Analysis

        <!--
    <div class="radiolist">
    <p class="selected">
        <input id="monitor_input" name="mode" value="monitor" type="radio">
        <a class="radio-select" href="#">Monitor mode</a>
    </p>
    <p>
        <input id="analysis_input" name="mode" value="analysis" type="radio">
        <a class="radio-select" href="#">Analysis mode</a>
    </p>
    </div>
    -->

        </div>
        <div style="display: none;" id="end_div" align="center" class="float-left"><input type="text" id="end_input"></div>
        <div id="monitor_end_div" align="center" class="float-left"></div>
    
   </div>


</div>


	<div id="animation"  style="">
	<canvas id="sketch" data-processing-sources="garden.pde" tabindex="0" width="1150" height="600" style="image-rendering: -webkit-optimize-contrast !important;"></canvas> 
	</div>
	<div id="title" style=""><h1 class="prettytitle">Garden Dashboard</h1>
		<p class="prettytitle" id="subtitle">Kijani Grows Aquaponics</p>
	</div>

<script>
jQuery.fn.onEnter = function(callback)
{
    this.keyup(function(e)
    {
        if(e.keyCode == 13)
    {
    e.preventDefault();
    if (typeof callback == 'function')
    callback.apply(this);
    }
    }
    );
    return this;
}

$(".radiolist .radio-select").click(
    function(event) {
        event.preventDefault();
        var $boxes = $(this).parent().parent().children();
        $boxes.removeClass("selected");
        $(this).removeAttr("checked");
        $(this).parent().addClass("selected");
        $(this).parent().find(":radio").attr("checked","checked");
    }
);

var paramPairs = getQueryParameters();
var garden = paramPairs.garden;
var visibleTimeRange = 60 * 1000; // time range (milliseconds) to display on graphs 

var categories = {
   
   //continues variable measurements
   "flow_rate": ["report", "flow_rate_sensor", "flowRate"],
   "temperature": ["report", "temperature_sensor", "temperature"],
   "light_level": ["report", "photocell_sensor", "lightLevel"],
   "gb_level": ["report", "gb_level_sensor", "gbLevel"],
   "humidity": ["report", "humidity_sensor", "humidity"],

   //boolean variable measurements
   "tank_full": ["report", "tank_level_sensor", "full"],
   "fish_feeder": ["report", "fish_feeder", "on"],
   "fish_tank_pump": ["report", "fish_tank_pump", "on"],
   "flow_switch": ["report", "flow_switch_sensor", "flow"],
   "grow_lights": ["report", "grow_lights", "on"],
   "leak": ["report", "leak_detector_sensor", "leak"],
   "backup_reservoir": ["report", "reservior_level_sensor", "full"],
   "reservoir_pump": ["report", "reservior_pump", "on"],

}
var dataGarden;

var initData;
//map (key is the same as in categories)
var seriesData = initSeriesData(categories);
var graphs = [];
var hoverGraphs = [];

// var refreshInterval = 5000; // 10 seconds
// var maxNumPointsPerInterval = 1;
var lastEndTime;

var ptsPerRefresh = 1;
var dataInterval = 10000;
var averageDataInterval = 10000; // To estimate the index of old data to exclude
var refreshInterval = ptsPerRefresh * dataInterval;

var numInitialPoints = 10;

var start_input = $("#start_input");
var end_input = $("#end_input");

var monitor_input = $("#monitor_input");
var analysis_input = $("#analysis_input");

// variables for animation portion
var processingInstance;
var gardenAnim;
var animationTimer; // to set and stop setInterval
var garden;
var animationOn = 1;
start_input.datetimepicker({showSecond: true, timeFormat: 'HH:mm:ss', hourGrid: 4, minuteGrid: 10});
end_input.datetimepicker({showSecond: true, timeFormat: 'HH:mm:ss', hourGrid: 4, minuteGrid: 10});

start_input.onEnter(function() {
        clearInterval(updateInterval);
        setEndpoint(start_input.val(), end_input.val());
    }
);
end_input.onEnter(function() {
        clearInterval(updateInterval);
        setEndpoint(start_input.val(), end_input.val());
    }
)
createDataGarden();
setTimeout(
    function() {
        getData(garden, numInitialPoints, initGraphs);
    }, 5000);
var updateInterval;
setTimeout(
    function() {
        updateInterval = setInterval( function() { getLatestData(); }, refreshInterval );
    }, 5000);

$(function() {
    $("#monitor_input").jqTransform();
});

var chartStartWidth = $('#charts').width();
$(document).ready(function() {

$("input[name='mode']").change(function() {
    if ($("input[name='mode']:checked").val() == 'analysis') { // Analysis
        console.log('analysis');
        $("#monitor_start_div").hide();
        $("#monitor_end_div").hide();
        $("#start_div").show();
        $("#end_div").show();
        start_input.val($("#monitor_start_div").text());
        end_input.val($("#monitor_end_div").text());
        clearInterval(updateInterval);
        $("#animation").fadeOut('slow');
        animationOn = 0;
        clearInterval(animationTimer); 
        //$('div svg').animate({
            //width: "95%"}, 1000
        //);
        setTimeout(function() {
            $('#charts').animate({
                width: "87%"}, 2000
            );
            $('#slider').animate({
                width: "100%"}, 2000
            );
            graphs.map(function(graph) {
                graph.configure({width: 1236});
                graph.render();
            });
        }, 500);
   } else { // Monitor
        console.log('monitor');
        $("#monitor_start_div").show();
        $("#monitor_end_div").show();
        $("#start_div").hide();
        $("#end_div").hide();
        updateInterval = setInterval( function() { getLatestData(); }, refreshInterval );
        setTimeout(function() {
            $("#animation").fadeIn('slow');
        }, 2000);
        animationOn = 1;
        //$('div svg').animate({
            //width: "50%"}, 1000
        //);
        $('#charts').animate({
            width: chartStartWidth}, 2000
        );
        setTimeout(function() {
            graphs.map(function(graph) {
                console.log(graph);
                graph.configure({width: 670});
                graph.render();
            });
        }, 1500);

        /*
        $.each(seriesData, function(i, d) {
                seriesData[i].length = 0;
        });
        */

    }
});
});
    

// *** FUNCTIONS *** //

function setEndpoint(start, end) {
    start_date = new Date(start);
    if (!isValidDate(start_date)) {
        return;
    }
    var start_mil = start_date.getTime();
    end_date = new Date(end);
    if (!isValidDate(end_date)) return;
    console.log(end_date);
    var end_mil = end_date.getTime();

    console.log(start_mil);
    console.log(end_mil);

    var newData = dataGarden.getRange(start_mil, end_mil);

    $.each(seriesData, function(i, d) {
            seriesData[i].length = 0;
    });
    //console.log(seriesData);
    $.each(newData, function(i, item) {
        var time = new Date(item.time).getTime()/1000.0;

        $.each(categories, function(label, pathArray) {
            var val = getFieldValue(pathArray, item);
            seriesData[label].push({x: time, y: val});
        });
    });

    if (newData && newData.length > 0) {
        $.each(graphs, function(i, graph) {
            graph.update();
        });
    }
    var displayStartTime = new Date(seriesData['humidity'][0].x * 1000);
    displayStartTime.setHours(displayStartTime.getHours() + 8);
    start_input.val(displayStartTime.getMonth()+1 + "/" + displayStartTime.getDate() + "/" + displayStartTime.getFullYear() + " " + displayStartTime.getHours() + ":" + displayStartTime.getMinutes() + ":" + displayStartTime.getSeconds());

    var displayEndTime = new Date(seriesData['humidity'][seriesData['humidity'].length-1].x * 1000);
    displayEndTime.setHours(displayEndTime.getHours() + 8);
    end_input.val(displayEndTime.getMonth()+1 + "/" + displayEndTime.getDate() + "/" + displayEndTime.getFullYear() + " " + displayEndTime.getHours() + ":" + displayEndTime.getMinutes() + ":" + displayEndTime.getSeconds());
}

function isValidDate(d) {
      if ( Object.prototype.toString.call(d) !== "[object Date]" )
              return false;
        return !isNaN(d.getTime());
}


function createDataGarden(callback) {
    // console.log("createDataGarden()");
    dataGarden = new DataGarden(garden, false);
}

function getFieldValue(pathArray, object) {
    var found = object;
    $.each(pathArray, function(i, field) {
        if (field in found) {
            found = found[field];
        } else {
            console.error("getFieldValue(): " + field + " not found.");
            return 0;
        }
    });
    return found;

}

function initSeriesData(categories) {
    var series = {};
    $.each(categories, function(label, path) {
        series[label] = [];
    });
    return series;
}

function getQueryParameters() {
    var query = window.location.href.split('?')[1];
    //query won't be set if ? isn't in the URL
    if(!query) {
        return { };
    }

    var params = query.split('&');
    var pairs = {};
    $.each(params, function(i, param) {
        var pair = param.split('=');
        pairs[pair[0]] = pair[1];
    });

    return pairs;
}

function getData(garden, numEntries, callback) {
    initData = dataGarden.getInitialData(visibleTimeRange);

    textStatus = null;
    jqXHR = null;

    callback(initData, textStatus, jqXHR);

    // var curTime = new Date().toJSON();
    // lastEndTime = curTime;

    // var queryUrl = "http://50.19.108.27/arduino/garden/" + garden + 
    //      "?num="+numEntries;

    // // "http://50.19.108.27/arduino/garden/ + garden + 
    // //     "?end_time="+curTime+"&num="+numEntries;

    // jQuery.ajax({
    //     url: queryUrl,
    //     type: "GET",
    //     dataType: "json",
    //     success: callback
    // });
}


function initGraphs(data, textStatus, jqXHR) {
    $.each(data, function(i, item) {
        //var time = new Date(item.time);
        var time = new Date(item.time).getTime()/1000.0;
        $.each(categories, function(label, pathArray) {
            var val = getFieldValue(pathArray, item);
            seriesData[label].push({x: time, y: val});
        });
    });

    $.each(categories, function(label, path) {
        seriesData[label] = seriesData[label];
    });
    var startTime = new Date(data[0].time);
    startTime.setHours(startTime.getHours() + 8);
    $("#monitor_start_div").text(startTime.getMonth()+1 + "/" + startTime.getDate() + "/" + startTime.getFullYear() + " " + startTime.getHours() + ":" + startTime.getMinutes() + ":" + startTime.getSeconds());


    var latestTime = new Date(data[data.length-1].time);
    latestTime.setHours(latestTime.getHours() + 8);
    $("#monitor_end_div").text(latestTime.getMonth()+1 + "/" + latestTime.getDate() + "/" + latestTime.getFullYear() + " " + latestTime.getHours() + ":" + latestTime.getMinutes() + ":" + latestTime.getSeconds());

    initGraph("temperature", "Temperature", "#c05020", "C", 15, 30);
    initGraph("flow_rate", "Flow rate", "#30c020", "gpm", 0, 100);
    initGraph("light_level", "Light level", "blue", "%", 0, 100);
    initGraph("gb_level", "Growbed water level", "green", "%", 0, 140);
    initGraph("humidity", "Humidity", "yellow", "", 0, 100); // TODO: check this


    initBooleanGraph("tank_full", "Tank full", "blue");
    initBooleanGraph("fish_feeder", "Fish feeder", "orange");
    initBooleanGraph("flow_switch", "Flow switch", "green");
    initBooleanGraph("grow_lights", "Grow lights", "purple");
    initBooleanGraph("leak", "Water leak", "red");
    initBooleanGraph("backup_reservoir", "Backup reservoir", "yellow");
    initBooleanGraph("reservoir_pump", "Reservoir pump", "teal");

    var hoverDetail = new Rickshaw.Graph.HoverDetail( {
        graphs: graphs,//data[0],
        //xFormatter: function(x) { return x + " seconds" },
        yFormatter: hoverGraphs
        //yFormatter: function(y) { return y + " " + yunits }
    } );
    //create slider
    var slider = new Rickshaw.Graph.RangeSlider(
        {
            graph: graphs,
            element: $('#slider')
        }
    );

} 

function initBooleanGraph(htmlId, name, color, isBooleanGraph) {
    initGraph(htmlId, name, color, "", 0, 1, true);
}

function initGraph(htmlId, name, color, yunits, ymin, ymax, isBooleanGraph) {
    var height = 90;
    var graphType = "area";
    var gapSize = "0";

    var yaxisId = htmlId + "_yaxis";
    var wrapperId = htmlId + "_wrapper";
    var labelId = htmlId + "_label";
    var labelClass = "label";

    if(isBooleanGraph) {
        height = 20;
        graphType = "bar";
        gapSize = 0;
        labelClass = "label_boolean"
    } 

    // create a new graph!
    $("#chart_container").append("<div id='" + wrapperId + "' class='rsgraph_wrapper'></div>");
    $("#" + wrapperId).append("<div id='" + labelId + "' class='" + labelClass + "'>" + name + "</div>");
    $("#" + wrapperId).append("<div id='" + htmlId + "'></div>");
    $("#" + wrapperId).append("<div id='" + yaxisId + "'></div>");

    //console.log(seriesData[htmlId]);
    var graph = new Rickshaw.Graph(
    {
	    element: document.getElementById(htmlId),
	    width: 670,
	    //width: 960,
	    height: height,
        min: ymin,
        max: ymax,
        padding:
        {
            top: .1,
            bottom: .1
        },
	    renderer: graphType,
        gapSize: gapSize,
        //dataURL: "http://50.19.108.27/arduino/garden/v1.1/?num=100",
        //onData: function(d) { return d },
    	series: [{
			color: color,
			data: seriesData[htmlId],
			name: name,
		}]
    });
    


    /*
    var hoverDetail = new Rickshaw.Graph.HoverDetail( {
        graph: graph,
        //xFormatter: function(x) { return x + " seconds" },
        yFormatter: function(y) { return y + " " + yunits }
    } );
    */
    //console.log("hover: ");
    //console.log(hoverDetail);

    graphs.push(graph);
    hoverGraphs[graph.element.id] = yunits;


    // var legend = new Rickshaw.Graph.Legend( {
    //     graph: graph,
    //     element: document.getElementById('legend')

    // } );

    // var shelving = new Rickshaw.Graph.Behavior.Series.Toggle( {
    //     graph: graph,
    //     legend: legend
    // } );


    var time = new Rickshaw.Fixtures.Time();
    //var minutes = time.unit('15 second');
    //if (graph.element.id == "reservoir_pump") {
        var xAxis = new Rickshaw.Graph.Axis.Time( {
           graph: graph,
           
           //timeUnit: minutes,
        } );
        xAxis.render();
    //}
   

    // console.log($("#" + yaxisId));

    if (["temperature", "flow_rate", "light_level", "gb_level", "humidity"].indexOf(graph.element.id) != -1) {
        var yAxis = new Rickshaw.Graph.Axis.Y( {
            graph: graph,
            orientation: 'right',
            tickFormat: Rickshaw.Fixtures.Number.formatKMBT,
            width: 50,
            // element: document.getElementById($("#" + yaxisId)),
            pixelsPerTick: 25,
        } );

        yAxis.render();
    }

    graph.render(); 

}

var getLatestData = function(){
    // console.log("dashboarddead.getLastestData()");
    
    var newData = dataGarden.getLastN(ptsPerRefresh);

    var newSeriesData = initSeriesData(categories);
    
    $.each(newData, function(i, item) {
        var time = new Date(item.time).getTime()/1000.0;

        $.each(categories, function(label, pathArray) {
            var val = getFieldValue(pathArray, item);
            seriesData[label].push({x: time, y: val});
        });

    var latestTime = new Date(newData[newData.length-1].time);
    $("#monitor_end_div").text(latestTime.getMonth()+1 + "/" + latestTime.getDate() + "/" + latestTime.getFullYear() + " " + latestTime.getHours() + ":" + latestTime.getMinutes() + ":" + latestTime.getSeconds());

    // FOR ANIMATION 

    if(!gardenAnim) { 
	    processingInstance= Processing.getInstanceById('sketch');
    	console.log("Init processingInstance");
	gardenAnim = new processingInstance.MediaBed();
	//gardenAnim =  new processingInstance.MediaBed(70,50,95,1.23,4,1,1,1,1,0,1);
	processingInstance.draw();
        
    } 
    if (animationOn) {
	//var p = new processingInstance.MediaBed(gbLevel, ftLevel, lightLevel, flowRate, numFish, feederOn, lightOn, waterIsFlowing, pumpOn, leakage, isFlowing);
        var currentState = newData[0]['report'];
    	var gbLevel = currentState['gb_level_sensor'].gbLevel;
    	var ftLevel = currentState['tank_level_sensor'].full == 1;
    	var lightLevel = currentState['photocell_sensor'].lightLevel;
    	var flowRate = currentState['flow_rate_sensor'].flowRate;
    	var numFish = 5;
    	var feederOn = currentState['fish_feeder'].on;
    	var lightOn = currentState['grow_lights'].on;
    	var waterIsFlowing = currentState['flow_switch_sensor'].flow;
    	var pumpOn = currentState['fish_tank_pump'].on;
    	var leakage = currentState['leak_detector_sensor'].leak;
    	var isFlowing = flowRate >= 0.5 ? 1 : 0; // IS THIS RIGHT? ASK MAUNDU LATER?
        var timestamp = new Date(time * 1000);
    	gardenAnim.updateMediaBed(gbLevel, ftLevel, lightLevel, flowRate, numFish, feederOn, lightOn, waterIsFlowing, pumpOn, leakage, isFlowing, timestamp);
	var frameInterval = 100;
    	animationTimer = setInterval(function() { gardenAnim.animateMediaBed(); }, frameInterval);
	//gardenAnim = new processingInstance.MediaBed(gbLevel, ftLevel, lightLevel, flowRate, numFish, feederOn, lightOn, waterIsFlowing, pumpOn, leakage, isFlowing);
     } else {
	clearInterval(animationTimer);
     }

    });


    if (newData && newData.length > 0) {
        // $.each(categories, function(label, path) {
        //     newSeriesData[label] = newSeriesData[label].reverse();
        //     seriesData[label].push.apply(seriesData[label], newSeriesData[label]);
        // });

        //TODO: in progress -- remove old data outside the visibleTimeRange
        // $.each(seriesData, function(series, dataArr) {
        //     console.log(series + " -> " + dataArr);
        //     console.log(dataArr.slice(-1));

        //     var earliestTimeToShow = dataArr.slice(-1)[0].x - visibleTimeRange;
        //     console.log("earliest time to show: " + earliestTimeToShow);
        //     var firstIndexToShow = 0;
        //     console.log(firstIndexToShow + " -> "+ dataArr[firstIndexToShow]);
        //     while (dataArr[firstIndexToShow].x < earliestTimeToShow) {
        //         firstIndexToShow++;
        //         console.log("first index to show: " + firstIndexToShow);
        //     }
        //     seriesData[series] = dataArr.slice(firstIndexToShow, dataArr.length);

        // });

        $.each(graphs, function(i, graph) {
            graph.update();
        });
    }



    // var start = lastEndTime;
    // var end = (new Date()).toJSON();
    // lastEndTime = end;

    // var queryUrl = "http://50.19.108.27/arduino/garden/range/" + garden 
    //     + "?start_time=" + start + "&end_time=" + end + "&num=" + ptsPerRefresh;
    //     console.log(queryUrl);
    
    // jQuery.ajax({
    //     url: queryUrl,
    //     type: "GET",
    //     dataType: "json",
    //     success: function(newData, textStatus, jqXHR){
    //         console.log("New data received: " + newSeriesData);
            

    //         // var newSeriesData = initSeriesData(categories);

    //         $.each(newData, function(i, item) {
    //             var time = new Date(item.time).getTime()/1000.0;
    //             console.log("New data time: " + new Date(time * 1000));
    //             $.each(categories, function(label, pathArray) {
    //                 var val = getFieldValue(pathArray, item);
    //                 newSeriesData[label].push({x: time, y: val});
    //             });
    //         });

    //         if (newData.length > 0) {
    //             $.each(categories, function(label, path) {
    //                 newSeriesData[label] = newSeriesData[label].reverse();
    //                 seriesData[label].push.apply(seriesData[label], newSeriesData[label]);
    //             });

    //             $.each(graphs, function(i, graph) {
    //                 console.log("update " + graph.series[0].name)
    //                 graph.update();
    //             });
    //         }
    //     },
    // });
};

    // FUNCTIONS FOR ANIMATION PART
    

</script>
</body>
<footer id="tag">
<div style='color:#aaa'>Visualization by Cindy Chang, Emily Cheng, Julia Lee, JJ Liu</div>
<div style='color:#aaa'>For Kiani Grows: Urban Garden Systems (www.kijanigrows.com)</div>
</footer>


<!DOCTYPE html>
<head>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

	<link type="text/css" rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css">
	<link type="text/css" rel="stylesheet" href="css/graph.css">
	<link type="text/css" rel="stylesheet" href="css/detail.css">
	<link type="text/css" rel="stylesheet" href="css/legend.css">
	<link type="text/css" rel="stylesheet" href="css/lines.css">
    <link type="text/css" rel="stylesheet" href="css/custom.css">
	
    <script src="../d3.v2.js"></script>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.15/jquery-ui.min.js"></script>

    <script src="http://stanford.edu/~jsquared/cgi-bin/clone/datagarden.js"></script>

	<script src="rickshaw.js"></script>
	<script src="Rickshaw.Graph.RangeSlider.js"></script>
</head>
<body>

<div id="charts">
    <div id="chart_container"></div>

    <div id="legend_container">
        <div id="smoother" title="Smoothing"></div>
        <div id="legend"></div>
    </div>

    <div id="slider"></div>
</div>

<script>

var garden = getQueryParameters();
var categories = {
   "Flow Rate": ["report", "flow_rate_sensor", "flowRate"],
   "Temperature": ["report", "temperature_sensor", "temperature"],
}
var dataGarden;

var initData;
//map (key is the same as in categories)
var seriesData = initSeriesData(categories);
var graphs = [];

// var refreshInterval = 5000; // 10 seconds
// var maxNumPointsPerInterval = 1;
var lastEndTime;

var ptsPerRefresh = 1;
var dataInterval = 10000;
var refreshInterval = ptsPerRefresh * dataInterval;

var numInitialPoints = 10;

createDataGarden();
setTimeout(
        function() {
            getData(garden, numInitialPoints, initGraphs);
        }, 500);

// *** FUNCTIONS *** //

function createDataGarden(callback) {
    console.log("createDataGarden()");
    dataGarden = new DataGarden(garden, false);
}

function getFieldValue(pathArray, object) {
    var found = object;
    $.each(pathArray, function(i, field) {
        if (field in found) {
            found = found[field];
        } else {
            console.error("getFieldValue(): " + field + " not found.");
            return null;
        }
    });
    return found;

}

function initSeriesData(categories) {
    var series = {};
    $.each(categories, function(label, path) {
        series[label] = [];
    });
    return series;
}

function getQueryParameters() {
    var query = window.location.href.split('?')[1];
    //query won't be set if ? isn't in the URL
    if(!query) {
        return { };
    }

    var params = query.split('&');
    var pairs = {};
    $.each(params, function(i, param) {
        var pair = param.split('=');
        pairs[pair[0]] = pair[1];
    });

    garden = pairs.garden;
    return garden;
}

function getData(garden, numEntries, callback) {
    console.log("getData()");
    initData = dataGarden.getInitialData();
    textStatus = null;
    jqXHR = null;

    callback(initData, textStatus, jqXHR);

    // var curTime = new Date().toJSON();
    // lastEndTime = curTime;

    // var queryUrl = "http://50.19.108.27/arduino/garden/" + garden + 
    //      "?num="+numEntries;

    // // "http://50.19.108.27/arduino/garden/ + garden + 
    // //     "?end_time="+curTime+"&num="+numEntries;

    // jQuery.ajax({
    //     url: queryUrl,
    //     type: "GET",
    //     dataType: "json",
    //     success: callback
    // });
}

function initGraphs(data, textStatus, jqXHR) {
    $.each(data, function(i, item) {
        var time = new Date(item.time).getTime()/1000.0;
        $.each(categories, function(label, pathArray) {
            var val = getFieldValue(pathArray, item);
            seriesData[label].push({x: time, y: val});
        });
    });

    $.each(categories, function(label, path) {
        seriesData[label] = seriesData[label].reverse();
    });

    initGraph("temperature", "Temperature", "#c05020", seriesData["Temperature"], "C");
    initGraph("flowrate", "Flow Rate", "#30c020", seriesData["Flow Rate"], " flowrateunits");

    //create slider
    var slider = new Rickshaw.Graph.RangeSlider(
        {
            graph: graphs,
            element: $('#slider')
        }
    );

//    setInterval( function() { getLatestData(); }, refreshInterval );

} 

function initGraph(htmlId, name, color, dataArr, yunits) {
    // instantiate a graph!
    var yaxisId = htmlId + "_yaxis";
    var wrapperId = htmlId + "_wrapper";
    $("#chart_container").append("<div id='" + wrapperId + "'></div>");
    $("#" + wrapperId).append("<div id='" + yaxisId + "'></div>");
    $("#" + wrapperId).append("<div id='" + htmlId + "' class='rsgraph'></div>");

    var graph = new Rickshaw.Graph(
    {
	    element: document.getElementById(htmlId),
	    width: 960,
	    height: 75,
        min: -30,
        max: 30,
        padding:
        {
            top: .1,
            bottom: .1
        },
	    renderer: 'scatterplot', //line',
        //dataURL: "http://50.19.108.27/arduino/garden/v1.1/?num=100",
        //onData: function(d) { return d },
    	series: [{
			color: color,
			data: dataArr,
			name: name,
		}]
    });
    


    hoverDetail = new Rickshaw.Graph.HoverDetail( {
        graph: graph,
        formatter: function(series, x, y) {
            var msg = series + " " + yunits;
            return msg;

        }
        // xFormatter: function(x) { return x + "seconds" },
        // yFormatter: function(y) { console.log('hey'); return y + " " + yunits }
    } );

    graphs.push(graph);

    graph.render(); 


    // var legend = new Rickshaw.Graph.Legend( {
    //     graph: graph,
    //     element: document.getElementById('legend')

    // } );

    // var shelving = new Rickshaw.Graph.Behavior.Series.Toggle( {
    //     graph: graph,
    //     legend: legend
    // } );

    // var axes = new Rickshaw.Graph.Axis.Time( {
	   // graph: graph
    // } );
    // console.log($("#" + yaxisId));
    var y_ticks = new Rickshaw.Graph.Axis.Y( {
        graph: graph,
    } );

    // axes.render();
}

var getLatestData = function(){
    console.log("dashboarddead.getLastestData()");
    
    var newData = dataGarden.getLastN(ptsPerRefresh);

    var newSeriesData = initSeriesData(categories);

    console.log("New data received: " + newData);
    
    $.each(newData, function(i, item) {
        var time = new Date(item.time).getTime()/1000.0;
        console.log("New data time: " + new Date(time * 1000));
        $.each(categories, function(label, pathArray) {
            var val = getFieldValue(pathArray, item);
            newSeriesData[label].push({x: time, y: val});
        });
    });

    if (newData.length > 0) {
        $.each(categories, function(label, path) {
            newSeriesData[label] = newSeriesData[label].reverse();
            seriesData[label].push.apply(seriesData[label], newSeriesData[label]);
        });

        $.each(graphs, function(i, graph) {
            console.log("update " + graph.series[0].name)
            graph.update();
        });
    }



    // var start = lastEndTime;
    // var end = (new Date()).toJSON();
    // lastEndTime = end;

    // var queryUrl = "http://50.19.108.27/arduino/garden/range/" + garden 
    //     + "?start_time=" + start + "&end_time=" + end + "&num=" + ptsPerRefresh;
    //     console.log(queryUrl);
    
    // jQuery.ajax({
    //     url: queryUrl,
    //     type: "GET",
    //     dataType: "json",
    //     success: function(newData, textStatus, jqXHR){
    //         console.log("New data received: " + newSeriesData);
            

    //         // var newSeriesData = initSeriesData(categories);

    //         $.each(newData, function(i, item) {
    //             var time = new Date(item.time).getTime()/1000.0;
    //             console.log("New data time: " + new Date(time * 1000));
    //             $.each(categories, function(label, pathArray) {
    //                 var val = getFieldValue(pathArray, item);
    //                 newSeriesData[label].push({x: time, y: val});
    //             });
    //         });

    //         if (newData.length > 0) {
    //             $.each(categories, function(label, path) {
    //                 newSeriesData[label] = newSeriesData[label].reverse();
    //                 seriesData[label].push.apply(seriesData[label], newSeriesData[label]);
    //             });

    //             $.each(graphs, function(i, graph) {
    //                 console.log("update " + graph.series[0].name)
    //                 graph.update();
    //             });
    //         }
    //     },
    // });
};


</script>

</body>


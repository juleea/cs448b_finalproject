
<!doctype>
<head>
	<link type="text/css" rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css">
	<link type="text/css" rel="stylesheet" href="css/graph.css">
	<link type="text/css" rel="stylesheet" href="css/detail.css">
	<link type="text/css" rel="stylesheet" href="css/legend.css">
	<link type="text/css" rel="stylesheet" href="css/lines.css">

	<script src="../d3.v2.js"></script>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.15/jquery-ui.min.js"></script>

	<script src="rickshaw.js"></script>
	<script src="Rickshaw.Graph.RangeSlider.js"></script>
</head>
<body>

<div id="chart_container">
	<div id="chart"></div>
	<div id="legend_container">
		<div id="smoother" title="Smoothing"></div>
		<div id="legend"></div>
	</div>
	<div id="slider"></div>
</div>

<script>

// set up our data series with 50 random data points

//var seriesData = [ [], [], [] ];
var flowData = [];
//flowData.push({'data':[]});

$.getJSON("http://50.19.108.27/arduino/garden/v1.1/?num=100",
function(data) {
    $.each(data, function(i,item){
    var flowRate = item.report.flow_rate_sensor.flowRate;
    var time = new Date(item.time).getTime()/1000.0;
    if (flowRate != null && !isNaN(flowRate) && flowRate != undefined) {
        flowData.unshift({x: time, y : flowRate});
    }
    if (i > 100)
        return false;
    });

    initGraph();

});

function initGraph() {
    // instantiate our graph!
    graph = new Rickshaw.Graph( {
	element: document.getElementById("chart"),
	width: 960,
	height: 500,
	renderer: 'line',
    //dataURL: "http://50.19.108.27/arduino/garden/v1.1/?num=100",
    //onData: function(d) { return d },
	series: [
		{
			color: "#c05020",
			data: flowData,
			name: 'flow rate'
		}/*, {
			color: "#30c020",
			data: seriesData[1],
			name: 'London'
		}, {
			color: "#6060c0",
			data: seriesData[2],
			name: 'Tokyo'
		}
        */
	]
    } );

    graph.render();

    hoverDetail = new Rickshaw.Graph.HoverDetail( {
        graph: graph
    } );

    legend = new Rickshaw.Graph.Legend( {
        graph: graph,
        element: document.getElementById('legend')

    } );

    shelving = new Rickshaw.Graph.Behavior.Series.Toggle( {
        graph: graph,
        legend: legend
    } );

    slider = new Rickshaw.Graph.RangeSlider( {
        graph: graph,
        element: $('#slider')
    } );
    axes = new Rickshaw.Graph.Axis.Time( {
	graph: graph
    } );
    axes.render();
}

var getLatestData = function(){
    jQuery.ajax({
    url: "http://50.19.108.27/arduino/garden/v1.1?num=60",
    type: "GET",
    /*data: {
        campaign_id : <?= $campaignId; ?>,
        most_recent : mostRecent
    },*/
    dataType: "json",
    success: function(newData, textStatus, jqXHR){
        var flowRate = newData.report.flow_rate_sensor.flowRate;
        var time = new Date(newData.time).getTime()/1000.0;
        console.log(flowRate);
        flowData.unshift( { x: time, y: flowRate } );
        graph.update();
    }
});
};

setInterval( function() { getLatestData(); }, 60000 );

</script>

</body>


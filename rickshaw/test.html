
<!doctype>
<head>
	<link type="text/css" rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css">
	<link type="text/css" rel="stylesheet" href="css/graph.css">
	<link type="text/css" rel="stylesheet" href="css/detail.css">
	<link type="text/css" rel="stylesheet" href="css/legend.css">
	<link type="text/css" rel="stylesheet" href="css/lines.css">
    <link type="text/css" rel="stylesheet" href="css/custom.css">
	
    <script src="../d3.v2.js"></script>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.15/jquery-ui.min.js"></script>

	<script src="rickshaw.js"></script>
	<script src="Rickshaw.Graph.RangeSlider.js"></script>
</head>
<body>

<div id="charts">
    <div id="chart_container"></div>

    <div id="legend_container">
        <div id="smoother" title="Smoothing"></div>
        <div id="legend"></div>
    </div>

    <div id="slider"></div>
</div>

<script>

var garden = getQueryParameters();
var categories = {
    "Flow Rate": ["report", "flow_rate_sensor", "flowRate"],
    "Temperature": ["report", "temperature_sensor", "temperature"],
}
//map (key is the same as in categories)
var seriesData = initSeriesData(categories);
var graphs = [];

getData(garden, 100, initGraphs);
setInterval( function() { getLatestData(); }, 60000 );


// *** FUNCTIONS *** //

function getFieldValue(pathArray, object) {
    var found = object;
    $.each(pathArray, function(i, field) {
        if (field in found) {
            found = found[field];
        } else {
            console.error("getFieldValue(): " + field + " not found.");
            return null;
        }
    });
    return found;

}

function initSeriesData(categories) {
    var series = {};
    $.each(categories, function(label, path) {
        series[label] = [];
    });
    return series;
}

function getQueryParameters() {
    var query = window.location.href.split('?')[1];
    //query won't be set if ? isn't in the URL
    if(!query) {
        return { };
    }

    var params = query.split('&');
    var pairs = {};
    $.each(params, function(i, param) {
        var pair = param.split('=');
        pairs[pair[0]] = pair[1];
    });

    garden = pairs.garden;
    return garden;
}

function getData(garden, numEntries, callback) {
    var curTime = new Date().toJSON();

    var queryUrl = "http://50.19.108.27/arduino/garden/range/" + garden + 
        "?end_time="+curTime+"&num="+numEntries;

    jQuery.ajax({
        url: queryUrl,
        type: "GET",
        dataType: "json",
        success: callback
    });
}

function initGraphs(data, textStatus, jqXHR) {
    $.each(data, function(i, item) {
        var time = new Date(item.time).getTime()/1000.0;
        $.each(categories, function(label, pathArray) {
            var val = getFieldValue(pathArray, item);
            seriesData[label].push({x: time, y: val});
        });
    });

    $.each(categories, function(label, path) {
        seriesData[label] = seriesData[label].reverse();
    });

    initGraph("temperature", "Temperature", "#c05020", seriesData["Temperature"]);
    initGraph("flowrate", "Flow Rate", "#30c020", seriesData["Flow Rate"]);

    //create slider
    var slider = new Rickshaw.Graph.RangeSlider(
        {
            graph: graphs,
            element: $('#slider')
        }
    );


} 

function initGraph(htmlId, name, color, dataArr) {
    // instantiate a graph!

    $("#chart_container").append("<div id='" + htmlId + "' class='rsgraph'></div>");

    var graph = new Rickshaw.Graph( {
	   element: document.getElementById(htmlId),
	   width: 960,
	   height: 75,
	   renderer: 'line',
        //dataURL: "http://50.19.108.27/arduino/garden/v1.1/?num=100",
        //onData: function(d) { return d },
    	series: [{
			color: color,
			data: dataArr,
			name: name,
		}]
    });
    
    graphs.push(graph);

    graph.render(); 

    var hoverDetail = new Rickshaw.Graph.HoverDetail( {
        graph: graph
    } );

    var legend = new Rickshaw.Graph.Legend( {
        graph: graph,
        element: document.getElementById('legend')

    } );

    var shelving = new Rickshaw.Graph.Behavior.Series.Toggle( {
        graph: graph,
        legend: legend
    } );

    var axes = new Rickshaw.Graph.Axis.Time( {
	   graph: graph
    } );

    axes.render();


}

var getLatestData = function(){
    jQuery.ajax({
    url: "http://50.19.108.27/arduino/garden/v1.1?num=60",
    type: "GET",
    dataType: "json",
    success: function(newData, textStatus, jqXHR){
        var flowRate = newData.report.flow_rate_sensor.flowRate;
        var time = new Date(newData.time).getTime()/1000.0;
        flowData.unshift( { x: time, y: flowRate } );
        graph.update();
    },
});
};


</script>

</body>

